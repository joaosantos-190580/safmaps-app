<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Protótipo - DBMS (Rotas)</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" />
    <link rel="stylesheet" href="./css/leaflet-routing-machine.css" />
	<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <style>
        .map {
            position: absolute;
            width: 98%;
            height: 98%;
        }
		.leaflet-control-geocoder-icon {
			width: 44px;
			height: 44px;
		}
		.leaflet-routing-container {
			display: none;
			margin-top: 3.2em !important;
		}
		.geocoder-icon-none {
			background-image: none;
			background-color: white;
		}
    </style>
</head>
<body>
    <div id="map" class="map"></div>
	<div class="leaflet-top leaflet-right" style="margin-top:1.2em; margin-right:1.5em">
		<div class="leaflet-control-geocoder leaflet-bar leaflet-control" style="">
			<!--
				<button class="leaflet-control-geocoder-icon" type="button" style=""><span style="display:none; color:red"><b>X</b></span></button>
			-->
			<button class="leaflet-control-geocoder-icon" type="button" style=""><i class="fa fa-times" style="display:none; color:red; margin-left:-.1em"></i></button>
		</div>
	</div>

	<script src="https://code.jquery.com/jquery-1.10.2.js"></script>
    <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYiHZL4JLYBrDqquu3EeaErg8LiZ_WFPo"></script>
    <script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js"></script>
    <script src="./js/leaflet-routing-machine.min.js"></script>
	<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

	<script>
		(function() {
			var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
					'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
				mbUrl = 'https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

			/*
				var map = L.map('map').setView([-12.7894, -51.1708], 5),
					geocoders = {
						'Nominatim': L.Control.Geocoder.nominatim(),
						'Bing': L.Control.Geocoder.bing('AlsFLEm5UIoF-8kfQdB-XlTCGU_pLLNliREprSZFOZfEr08UCqD0OCzhL5jWAwQn'),
					},
					selector = L.DomUtil.get('geocode-selector'),
						control = new L.Control.Geocoder({ geocoder: null }),
						btn,
						selection,
						marker;
			*/

			var map = L.map('map').setView([-12.7894, -51.1708], 5);
			/*
				selector = L.DomUtil.get('geocode-selector'),
					geocoder_control = new L.Control.Geocoder({ geocoder: L.Control.Geocoder.geocode() }),
					marker;
			*/
			
			L.tileLayer(mbUrl, {id: 'mapbox.streets', attribution: mbAttr}).addTo(map);
			//control.addTo(map);
			
			control = L.Routing.control({
				showAlternatives: true,
				autoRoute: true,		
				waypoints: [],
				routeWhileDragging: true,
				geocoder: L.Control.Geocoder.nominatim()
				//geocoder: geocoder_control
			}).addTo(map);
						
			/*
				function select(geocoder, el) {
					if (selection) {
						L.DomUtil.removeClass(selection, 'selected');
					}

					control.options.geocoder = geocoder;
					L.DomUtil.addClass(el, 'selected');
					selection = el;
				}

				for (var name in geocoders) {
					btn = L.DomUtil.create('button', '', selector);
					btn.innerHTML = name;
					(function(n) {
						L.DomEvent.addListener(btn, 'click', function() {
							select(geocoders[n], this);
						}, btn);
					})(name);

					if (!selection) {
						select(geocoders[name], btn);
					}
				}
			*/
			
			/*			
				function createButton(label, container) {
					var btn = L.DomUtil.create('button', '', container);
					btn.setAttribute('type', 'button');
					btn.innerHTML = label;
					return btn;
				}
			*/

			map.on('click', function(e) {
				/*
					var container = L.DomUtil.create('div'),
						startBtn = createButton('Start from this location', container),
						destBtn = createButton('Go to this location', container);
				
					L.popup()
						.setContent(container)
						.setLatLng(e.latlng)
						.openOn(map);
					
					L.DomEvent.on(startBtn, 'click', function() {
						control.spliceWaypoints(0, 1, e.latlng);
						map.closePopup();
					});
					
					L.DomEvent.on(destBtn, 'click', function() {
						control.spliceWaypoints(control.getWaypoints().length - 1, 1, e.latlng);
						map.closePopup();
					});
				*/

				if ($("div.leaflet-routing-container").css("display") !== 'none') {
					// Adding new routes to the array
					if (control.getWaypoints()[0].name == '') {
						control.spliceWaypoints(0, 1, e.latlng);
					} else {
						control.spliceWaypoints(control.getWaypoints().length - 1, 1, e.latlng);
					}
				} else {
					
				}
			
				/*
					var result; // = control.getWaypoints()[control.getWaypoints().length - 1];
					control.getWaypoints().forEach(function(point, i){
						if (point.name != '') {
							result = control.getWaypoints()[i];
						}
					});
					
					if (result) {
						if (typeof marker !== 'undefined') {
							map.removeLayer(marker);
						}
							marker = L.marker(result.center).bindPopup(result.html || result.name).addTo(map).openPopup();
					}
				*/
			
				/*
					//control.options.geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()), function(results) {
					geocoder_control.options.geocoder.reverse(e.latlng, map.options.crs.scale(map.getZoom()), function(results) {
						var r = results[0];
						if (r) {
							if (marker) {
								map.removeLayer(marker);
							}
							marker = L.marker(r.center).bindPopup(r.html || r.name).addTo(map).openPopup();
						}
					});
				*/
			});
			
			$("button.leaflet-control-geocoder-icon")
			  .mouseover(function() {
				//$(this).css("background-image", "none");
				$(this).removeClass("leaflet-control-geocoder-icon").addClass("geocoder-icon-none");
				$(this).find("i").css("display", "block");
				$(this).css("width", "26px"); $(this).css("height", "26px");
				$("div.leaflet-routing-container").css("display", "block");
			  })
			  .on("click", function() {
				$("div.leaflet-routing-container").css("display", "none");
				$(this).removeClass("geocoder-icon-none").addClass("leaflet-control-geocoder-icon");
				$(this).find("i").css("display", "none");
				$(this).css("width", "44px"); $(this).css("height", "44px");
				
				// Reset route
				control.getPlan().setWaypoints([]);
			  });
		})();

	</script>
</body>
</html>